## 文件系统基本常识

在文件系统中，所有的磁盘内容会以**文件和目录的形式**呈现给用户。不同的文件系统（如 NTFS、ext4、FAT32）有各自独特的**命名空间**，即文件路径的组织结构。

### 物理磁盘结构
在磁盘的物理层面，磁盘被分为**扇区**（Sector）。每个扇区的大小通常为512字节或4KB。多个扇区组成**簇**（Cluster，或称块Block），一个簇是文件系统在存储数据时的基本单位，通常一个簇的大小是4KB、8KB或更大。文件系统将文件数据按簇来存储，簇的大小会影响磁盘空间的利用率。

### 文件的数据和元数据
- **文件数据**：是指文件的实际内容，存储在磁盘上用于保存用户信息的部分。
- **文件元数据**：包含文件的**属性信息**，如：
  - **文件的时间戳**：记录文件的创建时间、修改时间和最后访问时间。
  - **文件的所有者**：表示文件的拥有者，通常与文件的权限系统相关。
  - **文件的权限**：描述谁可以读取、写入或执行文件。
  - **文件的物理位置**：文件在磁盘上的存储位置，指示文件数据存储在哪些簇中。文件系统会根据这些信息管理文件的读写操作。

此外，文件元数据通常还包括文件名、大小、文件类型等信息。文件系统利用这些元数据来管理文件的存取、删除和权限控制。

### 其他补充：
- **目录结构**：文件系统通过**目录**来组织文件，这些目录形成一个层级结构，类似树状结构，帮助用户和程序更方便地存取文件。
- **磁盘管理**：文件系统还会管理磁盘的空间使用情况，如**空闲空间管理**、**文件分配表**（如FAT表）或**inode**结构（如在Unix类文件系统中使用）。

## 分布式文件系统
节点分为两类：名称节点（namenode）和数据节点（datanode）。
名称节点负责存储元数据，数据节点负责存储块数据。

HDFS的特性：
- 优点
	- 流数据读写
	- 大型数据读写（tb pb级别）
	- 一次写入，多次读取
- 缺点
	 - 不支持随机写入

### 块（Block）
 HDFS默认一个块128mb,HDFS块的大小远远大于普通文件系统，可以最小化寻址开销。
 - 支持大规模文件读写，文件分块存储到不同的节点，所以系统可以存储大于任一节点容量的文件。
 - 简化系统设计，由于块的大小是固定的，可以很方便地计算出各个节点需要存储多少个块，而且元数据和文件数据想分离，方便管理。
 - 适合数据冗余备份。
 - 不适合存储大量小文件，因为每个文件至少占一个块，存储大量小文件会严重影响寻址效率 。

### 名称节点（NameNode）

名称节点负责管理分布式文件系统的命名空间（Namespace），保存了两个核心数据结构：Fsimage、EditLog.
- Fsimage用于维护文件系统树以及文件树中所有文件和文件夹的元数据。
- EditLog操作日志文件记录了所有针对文件的创建、删除、重命名等操作的日志。

#### 命名空间 (Namespace)
HDFS 的命名空间类似于传统文件系统中的目录结构，它存储文件的路径信息、目录信息和文件的相关属性（如权限、所有者等）。命名空间管理了文件和目录之间的关系，确保文件和目录的路径唯一性。它由 **NameNode** 管理，**NameNode** 是 HDFS 中的核心组件，负责所有与文件系统元数据相关的请求。

- **命名空间** 存储着文件系统的结构和文件的所有元数据。它包含了所有的文件和目录信息，如文件路径、权限、所有者、时间戳等。

#### fsimage
`fsimage` 是一个包含整个文件系统命名空间快照的文件。它是 HDFS 元数据的持久化存储，记录了文件系统的状态。每当 HDFS 启动时，**NameNode** 会加载 `fsimage` 文件中的内容，恢复文件系统的状态。

- **fsimage** 记录了从文件系统启动以来所有元数据的最终状态，表示文件系统的持久化快照。它是一个完整的文件系统元数据的静态镜像。
- 每次 HDFS 启动时，NameNode 会从磁盘加载 `fsimage` 文件，恢复元数据的最新状态。`fsimage` 文件的存在保证了即使在系统重启后，也能够恢复到最近的持久化状态。

#### editlog
`editlog` 是一个日志文件，记录了所有对 HDFS 命名空间的修改操作。每次对文件系统进行更改（例如创建文件、删除文件、修改权限等），这些更改都会被写入 `editlog` 文件。

- **editlog** 记录了每次对命名空间进行修改的操作，且仅记录增量修改。它用于保证在 NameNode 崩溃或重启后能够恢复到修改发生时的状态。
- 与 `fsimage` 不同，`editlog` 是增量记录，存储了对文件系统的所有修改操作。`editlog` 会不断增长，会定期通过第二名称节点进行 Checkpointing 合并。

### 第二名称节点 (Secondary NameNode) 与 Checkpointing

在 HDFS 中，**Secondary NameNode** 并不是主 NameNode 的备份，它的主要职责是辅助主 NameNode 进行 **Checkpointing**，以防止 `editlog` 文件无限增长，保证文件系统元数据的稳定性和可恢复性。

#### 主要职责
- 定期从主 **NameNode** 下载当前的 `fsimage` 文件和累积的 `editlog` 文件。
- 将 `fsimage` 和 `editlog` 合并，生成新的、包含最新修改的 `fsimage` 文件。
- 将新的 `fsimage` 文件上传回主 **NameNode**，并通知主 NameNode 清空已合并的 `editlog`，从而防止 `editlog` 无限增长。

#### Checkpointing 流程
1. **获取文件**  
   Secondary NameNode 定期与主 NameNode 通信，获取当前最新的 `fsimage` 文件以及自上次 Checkpointing 之后积累的 `editlog` 文件。

2. **合并操作**  
   Secondary NameNode 在本地将 `editlog` 文件中的所有操作应用到 `fsimage` 中，生成一个新的 `fsimage` 文件。这一步保证了新的 `fsimage` 包含了最新的文件系统元数据状态。

3. **上传更新**  
   将新的 `fsimage` 文件上传回主 NameNode，主 NameNode 替换旧的 `fsimage`，同时清空已经合并到 `fsimage` 中的 `editlog`，从而减小 `editlog` 文件大小，保证系统稳定。

#### Secondary NameNode 的特点
- **不是备份 NameNode**：它不能在主 NameNode 故障时直接替代 NameNode。
- **降低恢复成本**：通过定期合并 `fsimage` 和 `editlog`，减少 NameNode 崩溃时恢复操作所需应用的 `editlog` 数量。
- **提高系统稳定性**：避免 `editlog` 文件过大导致 NameNode 重启和恢复变慢。

#### 总结
Secondary NameNode 的核心作用是 **辅助 Checkpointing**：
- 保证 `fsimage` 快照与 `editlog` 的增量修改同步；
- 防止 `editlog` 文件无限增长；
- 降低主 NameNode 崩溃后的恢复成本。

通过 Secondary NameNode 的定期 Checkpointing，HDFS 能够保持命名空间元数据的持久性和一致性，同时提高系统的健壮性和可靠性。

### 概述总结
- **命名空间** 由 **NameNode** 管理，存储文件系统的元数据。
- **fsimage** 是文件系统的快照，包含命名空间的完整状态，作为文件系统元数据的持久化存储。
- **editlog** 记录文件系统对命名空间的增量修改，确保文件系统的最新状态能够恢复。
- **Checkpointing** 通过将 `fsimage` 和 `editlog` 合并来避免 `editlog` 文件过大，并定期生成新的 `fsimage` 文件。
- **Secondary NameNode** 定期从主 **NameNode** 获取 `fsimage` 和 `editlog`，进行合并操作，并将新的 `fsimage` 返回给主 **NameNode**。

这样，`fsimage` 和 `editlog` 的相互作用确保了 HDFS 能够高效、持久地管理文件系统元数据，并能够在发生故障时快速恢复。
 